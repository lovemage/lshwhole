# 訂單處理流程與規範

## 🔄 訂單狀態流轉 (State Machine)
1.  **已付款 (Paid)**: 下單成功，貨款已從錢包扣除。
2.  **抵台/待補運費 (Arrived TW)**: 商品抵台，管理員已計算運費與包材費。
3.  **準備出貨 (Ready to Ship)**: 會員已支付(核銷)運費，並填寫收件資料。
4.  **已出貨 (Shipped)**: 管理員已寄出並填寫追蹤單號。
5.  **已退款/部分退款 (Refunded)**: 因缺貨或其他因素，款項已退回錢包。

---

## 📝 詳細流程說明

### 1. 下單與支付
*   **適用對象**: Retail, Wholesale
*   **流程**:
    1.  會員提交訂單。
    2.  系統檢查**錢包餘額**。
        *   若餘額不足：**阻擋下單**，提示「餘額不足請儲值」。
        *   若餘額足夠：直接扣除貨款，訂單成立。

### 2. 商品抵台與運費計算 (管理員操作)
*   **流程**:
    1.  商品到達台灣倉庫。
    2.  **缺貨檢查 (Exception Handling)**:
        *   若發現國外廠商缺貨 (Out of Stock)：
            1.  管理員於後台標記缺貨商品項目與數量。
            2.  系統自動計算應退金額。
            3.  **退款執行**: 系統將款項退回**會員錢包**，並記錄退款交易日誌。
            4.  系統發送通知給會員：「商品缺貨，款項已退回錢包」。
            5.  若整筆訂單缺貨，狀態轉為 `已取消/已退款`；若部分缺貨，繼續後續流程。
    3.  管理員於後台開啟訂單，填入**國際運費**。
    4.  **分箱判斷**:
        *   若商品體積或重量過大，管理員勾選 `[需要分箱寄送]` 並輸入 `[箱數]`。
        *   系統自動計算**包材費** (箱數 * 包裝箱單價)。
    5.  管理員點擊 `[通知會員]` 按鈕。
    6.  系統透過 Resend 發送 Email 通知會員補繳費用。

### 3. 會員核銷與配送設定
*   **流程**:
    1.  會員收到通知登入系統。
    2.  **合併訂單 (Consolidation)**:
        *   若有多筆「待補運費」訂單，會員可選擇合併支付。
        *   **注意**: 若合併後超過超商/郵局限制，需分箱處理 (管理員端操作或規範限制)。
    3.  **支付運費**:
        *   系統顯示：`國際運費` + `包材費` (若有分箱)。
        *   扣款來源：**會員錢包**。
        *   若餘額不足：**無法核銷**，提示「餘額不足無法出貨，請儲值」。
    4.  **選擇運送方式**:
        *   **A. 郵局**:
            *   需填寫完整住家地址。
            *   限制：重量 < 20kg，長+寬+高 < 150cm。
        *   **B. 便利商店 (全家 / 7-11)**:
            *   需填寫正確店名與店號。
            *   限制：重量 < 5kg，外箱 < 45*30*30cm。
        *   **C. 自助賣貨便 (僅限 Wholesale)**:
            *   買家自行開立賣貨便賣場。
            *   **多箱分單規則**: 若貨量過大需分多箱，會員需開立**多個**賣場寄件單。
            *   系統需提供欄位讓會員填寫**多個** `[寄件編號]` (例如：編號1, 編號2...)。

### 4. 出貨 (管理員操作)
*   **流程**:
    1.  會員完成核銷後，後台訂單狀態變更為 `準備出貨`。
    2.  管理員包裝商品 (依分箱指示)。
    3.  管理員填寫 `[寄件單號]` (或系統自動帶入物流商單號)。
    4.  訂單狀態更新為 `已出貨`。

---

## ⚙️ 需開發功能與設定 (Admin/Client)

### 1. 國際運費與參數設定 (Admin)
*   需新增設定頁面，包含：
    *   **國家運費費率**: 每個國家 (韓/日/泰) 的 `Kg/Price`。
    *   **包裝箱價格**: 自定義每個箱子的費用 (預設 15 TWD)。

### 2. 訂單通知管理 (Admin)
*   管理 Resend 通知模板 (Subject, Body)。
*   支援變數：`{{user_name}}`, `{{order_id}}`, `{{amount_due}}` 等。

### 3. 運費計算介面優化 (Admin)
*   在訂單詳情頁增加「運費計算區塊」：
    *   輸入框：`國際運費` (手動輸入或依重量試算)。
    *   選項：`[ ] 需要分箱寄送` -> 輸入框 `[ ] 箱`。
    *   顯示總額：`國際運費 + (箱數 * 包裝箱單價)`。

### 4. 缺貨退款功能 (Admin)
*   訂單明細中需有「標記缺貨」按鈕。
*   點擊後彈出確認視窗，顯示退款金額預覽。
*   確認後觸發：更新訂單明細狀態、寫入錢包退款紀錄、發送通知。

### 5. 會員中心購買紀錄 (Client)
*   在會員面板 (`/member`) 新增「購買紀錄」區塊。
*   **功能需求**:
    *   顯示訂單列表 (分頁)。
    *   顯示訂單摘要：訂單編號、日期、總金額、**當前狀態** (處理中/待補運費/準備出貨/已出貨)。
    *   點擊可查看訂單詳情 (商品明細、運費明細、寄件資訊)。
    *   若狀態為「待補運費」，提供按鈕引導至核銷頁面。

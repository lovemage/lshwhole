## 專案 TODO：會員分級制度 & 熱銷商品功能

### 🎯 整體目標

- [ ] 實作會員分級制度（Guest / Retail / Wholesale）
- [ ] 實作「熱銷商品」專區與管理功能
- [ ] 依會員等級限制可瀏覽頁面、可見價格與可用付款方式
- [ ] 提供管理員會員升降級與熱銷商品管理後台

---

## 一、會員等級系統重構 TODO

### 1. 訪客會員（Guest Member，原 basic）

**定義：註冊後預設會員等級，只能瀏覽熱銷商品。**

- [ ] 調整資料庫與會員模型
  - [ ] 將 `profiles.tier` 中的 `'basic'` 調整為 `'guest'`（或新增 guest 值並更新既有資料）
  - [ ] 確認 `profiles` 中 tier 枚舉／約束與後端程式一致

- [ ] 訪客可見頁面與權限
  - [ ] 僅允許訪問「熱銷商品」列表頁（例如 `/hot-products`）
  - [ ] 禁止訪問 `/products` 一般商品列表（前端導頁與後端/中介層權限檢查）
  - [ ] 在嘗試訪問未授權頁面時，導向升級說明頁或提示升級為 Retail Member

- [ ] 訪客付款限制
  - [ ] 禁用「儲值金付款」選項
  - [ ] 預留「信用卡付款」欄位（UI 顯示為「尚未開放」）
  - [ ] 預留「貨到付款（店到店 / 綠界 / 藍新）」欄位（UI 顯示為「尚未開放」）
  - [ ] 確保後端 API 也阻擋訪客使用非允許的付款方式

- [ ] 首頁顯示熱銷商品
  - [ ] 在首頁 `/` 的版面中加入「熱銷商品」區塊（只顯示標記為熱銷的商品）
  - [ ] 區塊提供「查看更多」連結指向 `/hot-products`

---

### 2. 零售會員（Retail Member）

**申請條件：儲值滿 1,500 元，用戶可自行選擇申請升級。**

**維持資格條件：45 日內消費需滿 300 元（計算方式為成立訂單方可重置 45 日計算）**

- [ ] 升級條件與流程
  - [ ] 在會員中心或儲值金頁面顯示「升級為零售會員」條件（儲值 ≥ 1,500 TWD）
  - [ ] 前端按鈕：符合條件時顯示「申請升級」
  - [ ] 呼叫後端「訪客 → 零售」升級 API
  - [ ] 升級成功後更新 `profiles.tier = 'retail'` 並提示用戶

- [ ] 零售會員瀏覽與價格權限
  - [ ] 允許訪問 `/products` 頁面
  - [ ] 由 admin 設定開放的 L1 分類（國家），前端只顯示可見分類
  - [ ] 商品列表與詳情頁：
    - [ ] 只顯示零售價 `retail_price_twd`
    - [ ] 不顯示 `wholesale_price_twd`

- [ ] 付款方式限制
  - [ ] 僅允許「錢包／儲值金付款」
  - [ ] 禁用信用卡 / 貨到付款選項（前端隱藏或顯示為不可用；後端強制檢查）

- [ ] 零售會員「未消費提醒 / 關閉登入權限」
  - [ ] 在 `profiles` 或相關表記錄最後消費日期 `last_purchase_date`
  - [ ] 排程或查詢邏輯：找出 45 日未消費的零售會員
  - [ ] 管理員會員列表中對這些會員顯示「超過 45 日未消費」標記
  - [ ] **系統自動關閉登入權限邏輯**：45 日內消費未滿 300 元的零售會員關閉登入權限
  - [ ] 登入時檢查會員狀態，若權限被關閉則顯示提示：「系統無偵測到每月訂單，請聯繫管理員」
  - [ ] 管理員可以選擇：
    - [ ] 重新開啟登入權限
    - [ ] 凍結其儲值金（需定義凍結狀態與錢包處理流程）

---

### 3. 批發會員（Wholesale Member）

**申請條件：必須先是零售會員，繳交 6,000 元代理費 + 儲值 5,000 元(含)以上。**

**維持資格條件：45 日內消費需滿 300 元（計算方式為成立訂單方可重置 45 日計算）**
**降級規則：若 45 日內消費未滿 300 元，則關閉登入權限**

- [ ] 升級條件與流程（零售 → 批發）
  - [ ] 在會員中心顯示升級條件：
    - [ ] 儲值金 ≥ 5,000 元
    - [ ] 代理費 6,000 元
  - [ ] 前端提供「申請成為批發會員」按鈕（僅在條件達成時可點）
  - [ ] 處理 6,000 元代理費付款流程（從錢包扣款）
  - [ ] 後端升級 API：
    - [ ] 驗證儲值金 ≥ 5,000 元
    - [ ] 扣除 6,000 元代理費
    - [ ] 更新 `profiles.tier = 'wholesale'`
    - [ ] 記錄升級時間

- [ ] 批發會員「未消費提醒 / 關閉登入權限」
  - [ ] 依 `last_purchase_date` 判斷 45 日未消費的批發會員
  - [ ] 管理員會員列表中標記「超過 45 日未消費」
  - [ ] **系統自動關閉登入權限邏輯**：45 日內消費未滿 300 元的批發會員關閉登入權限
  - [ ] 登入時檢查會員狀態，若權限被關閉則顯示提示：「系統無偵測到每月訂單，請聯繫管理員」
  - [ ] 管理員可以手動重新開啟登入權限（若需要）

---

## 二、管理員功能 TODO

### 1. 會員管理（後台）

- [ ] 在管理員後台的會員管理頁增加：
  - [ ] 新增「訪客會員（guest）」等級選項
  - [ ] 顯示會員 `tier`（guest / retail / wholesale）
  - [ ] 顯示「最後消費日期」欄位
  - [ ] 顯示「登入權限狀態」欄位（已開啟 / 已關閉）
  - [ ] 顯示「45 日未消費」標記狀態（針對 Retail 和 Wholesale）

- [ ] 會員登入權限管理
  - [ ] 管理員可在後台手動開啟／關閉會員登入權限
  - [ ] 提供「開啟登入權限」按鈕（針對被關閉的會員）
  - [ ] 提供「關閉登入權限」按鈕（針對需要手動關閉的會員）
  - [ ] 記錄權限變更時間與操作者

- [ ] 超期未消費會員查詢
  - [ ] 後台提供篩選／列表：
    - [ ] 45 日未消費的零售會員（登入權限已關閉）
    - [ ] 45 日未消費的批發會員（登入權限已關閉）

### 2. 熱銷商品管理（後台）

- [ ] 管理後台介面
  - [ ] 新增「熱銷商品」管理分頁
  - [ ] 從已上架商品（`status = 'published'`）清單中勾選設為熱銷
  - [ ] 支援搜尋、篩選（依商品名稱、分類等）

- [ ] 熱銷標記資料結構
  - [ ] 選擇其一實作：
    - [ ] 新增 `hot_products` 表，關聯到 `products.id`
    - [ ] 或在 `products` 表新增 `is_hot boolean` 欄位
  - [ ] 確保前後端都使用一致的標記方式

- [ ] 前台顯示
  - [ ] 首頁熱銷區塊使用這個標記
  - [ ] `/hot-products` 頁面只顯示已標記為熱銷的商品

---

## 三、資料庫變更 TODO

- [ ] `profiles.tier` 調整
  - [ ] schema：允許 `'guest' | 'retail' | 'wholesale'`
  - [ ] 將現有 `'basic'` 資料遷移為 `'guest'`
  - [ ] 更新程式碼中所有 tier 判斷邏輯

- [ ] 熱銷商品標記
  - [ ] 新增 `hot_products` 表（或 `products.is_hot` 欄位）
  - [ ] 若使用獨立表，設計欄位：`product_id`, `created_at`, `created_by` 等

- [ ] 會員消費紀錄支援
  - [ ] 在 `profiles` 或關聯表新增／確認：
    - [ ] `last_purchase_date`（最後消費日期）
    - [ ] 可計算「45 日內累積消費金額」的來源（例如從 `orders` / `wallet_ledger` 統計）
  - [ ] 若需要，建立對應 VIEW 或 materialized view 方便查詢

---

## 四、前端頁面與權限控制 TODO

- [ ] 熱銷商品獨立頁面
  - [ ] 新增 `/hot-products` 頁面
  - [ ] 顯示熱銷商品列表（含圖片、名稱、價格）

- [ ] 登入權限檢查
  - [ ] 登入時檢查會員登入權限狀態
  - [ ] 若登入權限被關閉，顯示提示：「系統無偵測到每月訂單，請聯繫管理員」
  - [ ] 阻止被關閉權限的會員進入系統
  - [ ] 提供聯絡管理員的方式（電話、郵件等）

- [ ] 頁面訪問權限
  - [ ] 全站建立「會員等級」的前端 context / hook（例如 `useMemberTier`）
  - [ ] 根據 tier 控制：
    - [ ] guest：只能訪問 `/` + `/hot-products`
    - [ ] retail / wholesale：可以訪問 `/products` 等其他頁面
  - [ ] 未授權訪問時導向提示／升級頁面

- [ ] 付款方式 UI
  - [ ] Checkout 頁面依 tier 顯示不同付款方式：
    - guest：僅顯示預留但不可用的信用卡/貨到付款（標註尚未開放），禁止儲值金
    - retail：只顯示錢包 / 儲值金付款
    - wholesale：可沿用目前錢包支付流程（後續若開信用卡可再擴充）
  - [ ] 將不可用選項狀態與提示文案清楚標示

- [ ] 商品價格顯示
  - [ ] 商品列表 / 詳情頁根據 tier 顯示：
    - guest：僅顯示零售價（若允許看到價格）或部分遮蔽
    - retail：顯示零售價 `retail_price_twd`
    - wholesale：顯示批發價 `wholesale_price_twd`（可同時顯示原零售價作對比）

- [ ] 會員升級介面（清楚告知規則）
  - [ ] **升級為 Retail 會員頁面**
    - [ ] 顯示升級條件：儲值金 ≥ 1,500 元
    - [ ] 顯示 Retail 會員規則：
      - [ ] 可瀏覽一般商品
      - [ ] 可看零售價格
      - [ ] 可用儲值金付款
      - [ ] **維持資格：45 日內消費需滿 300 元**
      - [ ] **未達標會關閉登入權限**
      - [ ] **關閉後顯示提示：「系統無偵測到每月訂單，請聯繫管理員」**
    - [ ] 提供「申請升級」按鈕
    - [ ] 顯示升級成功／失敗訊息

  - [ ] **升級為 Wholesale 會員頁面**
    - [ ] 顯示升級條件：
      - [ ] 儲值金 ≥ 5,000 元
      - [ ] 代理費 6,000 元
    - [ ] 顯示 Wholesale 會員規則：
      - [ ] 可瀏覽所有商品
      - [ ] 可看批發價格
      - [ ] 可用儲值金付款
      - [ ] **維持資格：45 日內消費需滿 300 元**
      - [ ] **未達標會關閉登入權限**
      - [ ] **關閉後顯示提示：「系統無偵測到每月訂單，請聯繫管理員」**
    - [ ] 提供「申請升級」按鈕
    - [ ] 顯示升級成功／失敗訊息
    - [ ] 確認代理費扣款

---

## 五、API 需求 TODO

- [ ] 會員升級 API
  - [ ] 訪客 → 零售：檢查儲值金 ≥ 1,500 元
  - [ ] 零售 → 批發：
    - [ ] 檢查儲值金 ≥ 5,000 元
    - [ ] 扣除 6,000 元代理費
    - [ ] 記錄升級時間
  - [ ] 更新 `profiles.tier` 與相關紀錄
  - [ ] 升級時自動開啟登入權限（若之前被關閉）

- [ ] 會員登入權限管理 API（管理員）
  - [ ] 開啟登入權限 API
    - [ ] 僅限管理員角色呼叫
    - [ ] 更新 `profiles.login_enabled = true`
    - [ ] 記錄操作時間與操作者
  - [ ] 關閉登入權限 API
    - [ ] 僅限管理員角色呼叫
    - [ ] 更新 `profiles.login_enabled = false`
    - [ ] 記錄操作時間與操作者與原因

- [ ] 熱銷商品管理 API
  - [ ] 新增熱銷商品（標記 / unmark）
  - [ ] 取得熱銷商品列表（給前台首頁與 `/hot-products` 使用）

- [ ] 超期未消費會員查詢 API（自動關閉登入權限）
  - [ ] 提供給後台會員列表：
    - [ ] 回傳 45 日未消費零售會員（消費未滿 300 元）
    - [ ] 回傳 45 日未消費批發會員（消費未滿 300 元）
  - [ ] **自動關閉登入權限邏輯**：
    - [ ] 45 日內消費未滿 300 元的零售會員 → 自動關閉登入權限
    - [ ] 45 日內消費未滿 300 元的批發會員 → 自動關閉登入權限
  - [ ] 記錄權限關閉時間與原因

- [ ] 會員權限查詢 API
  - [ ] 依目前登入用戶回傳：
    - [ ] 會員等級（guest / retail / wholesale）
    - [ ] 可訪問頁面與可用付款方式
  - [ ] 供前端在初始載入時決定 UI 顯示與路由保護

---

## 六、會員等級規則總結表

| 項目 | Guest | Retail | Wholesale |
|------|-------|--------|-----------|
| **升級條件** | 註冊預設 | 儲值 ≥ 1,500 元 | 儲值 ≥ 5,000 元 + 代理費 6,000 元 |
| **維持資格** | - | 45 日內消費 ≥ 300 元 | 45 日內消費 ≥ 300 元 |
| **未達標結果** | - | 關閉登入權限 | 關閉登入權限 |
| **計算方式** | - | 成立訂單重置 45 日 | 成立訂單重置 45 日 |
| **可瀏覽頁面** | 熱銷商品 | 一般商品 | 所有商品 |
| **可見價格** | - | 零售價 | 批發價 |
| **付款方式** | 預留(未開放) | 儲值金 | 儲值金 |
| **登入權限** | 正常 | 45日未消費時關閉 | 45日未消費時關閉 |

---

## 七、重要提醒

- [ ] **升級頁面必須清楚告知會員 Retail 和 Wholesale 的規則**
  - [ ] 包括維持資格條件（45 日消費金額）
  - [ ] 包括未達標的關閉登入權限規則
  - [ ] 包括計算方式（成立訂單重置計時）
  - [ ] 包括關閉後的提示訊息

- [ ] **自動關閉登入權限邏輯**
  - [ ] 需要排程或定時檢查
  - [ ] 45 日內消費未滿 300 元時自動關閉登入權限
  - [ ] 關閉時需要記錄時間與原因
  - [ ] 關閉後需要通知會員

- [ ] **登入權限檢查**
  - [ ] 登入時必須檢查 `profiles.login_enabled` 狀態
  - [ ] 若為 false，顯示提示：「系統無偵測到每月訂單，請聯繫管理員」
  - [ ] 阻止被關閉權限的會員進入系統

- [ ] **消費金額計算**
  - [ ] 以「成立訂單」為基準（不是付款完成）
  - [ ] 需要統計 45 日內的訂單總金額
  - [ ] 需要排除已取消的訂單

- [ ] **管理員操作**
  - [ ] 管理員可手動開啟／關閉會員登入權限
  - [ ] 需要記錄所有權限變更操作
  - [ ] 提供權限變更歷史查詢